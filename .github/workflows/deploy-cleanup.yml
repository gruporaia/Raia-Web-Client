name: Cleanup Release Branch Deployments

on:
  delete:
    branches:
      - 'release/**'

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Extract Deleted Branch Information
        id: extract
        run: |
          RAW_BRANCH="${{ github.event.ref }}"
          echo "Deleted branch: $RAW_BRANCH"
          echo "deleted_branch=$RAW_BRANCH" >> $GITHUB_ENV

      - name: Fetch and Delete Cloudflare Deployments
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          echo "Fetching deployments for project: ${{ vars.PROJECT_NAME }}"
          RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/${{ vars.PROJECT_NAME }}/deployments" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json")
          
          if [[ -z "$RESPONSE" || "$RESPONSE" == "null" ]]; then
            echo "No deployments found or API response is empty."
            exit 0
          fi
          
          echo "$RESPONSE" | jq '.' > deployments.json
          DEPLOYMENT_IDS=$(jq -r --arg BRANCH "${{ github.event.ref }}" '.result[]? | select(.deployment_trigger.metadata.branch==$BRANCH) | .id' deployments.json)
          
          if [[ -z "$DEPLOYMENT_IDS" || "$DEPLOYMENT_IDS" == "null" ]]; then
            echo "No Cloudflare deployments found for branch: ${{ github.event.ref }}"
            exit 0
          fi
          
          echo "Found deployments to delete:"
          echo "$DEPLOYMENT_IDS"
          
          for ID in $DEPLOYMENT_IDS; do
            echo "Deleting Deployment ID: $ID"
            curl -X DELETE "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/${{ vars.PROJECT_NAME }}/deployments/$ID?force=true" \
              -H "Authorization: Bearer ${CF_API_TOKEN}" \
              -H "Content-Type: application/json"
          done
          
          echo "Cleanup completed for branch: ${{ github.event.ref }}"
